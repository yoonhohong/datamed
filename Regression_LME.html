<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yoon-Ho Hong">
<meta name="dcterms.date" content="2023-08-27">

<title>Linear mixed effects model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Regression_LME_files/libs/clipboard/clipboard.min.js"></script>
<script src="Regression_LME_files/libs/quarto-html/quarto.js"></script>
<script src="Regression_LME_files/libs/quarto-html/popper.min.js"></script>
<script src="Regression_LME_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Regression_LME_files/libs/quarto-html/anchor.min.js"></script>
<link href="Regression_LME_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Regression_LME_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Regression_LME_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Regression_LME_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Regression_LME_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#선형혼합효과-모델linear-mixed-effects-model" id="toc-선형혼합효과-모델linear-mixed-effects-model" class="nav-link active" data-scroll-target="#선형혼합효과-모델linear-mixed-effects-model">선형혼합효과 모델(Linear mixed effects model)</a></li>
  <li><a href="#고정-효과와-랜덤-효과" id="toc-고정-효과와-랜덤-효과" class="nav-link" data-scroll-target="#고정-효과와-랜덤-효과">고정 효과와 랜덤 효과</a></li>
  <li><a href="#랜덤-절편" id="toc-랜덤-절편" class="nav-link" data-scroll-target="#랜덤-절편">랜덤 절편</a></li>
  <li><a href="#랜덤-기울기" id="toc-랜덤-기울기" class="nav-link" data-scroll-target="#랜덤-기울기">랜덤 기울기</a></li>
  <li><a href="#통계적-검정-likelihood-ratio-test" id="toc-통계적-검정-likelihood-ratio-test" class="nav-link" data-scroll-target="#통계적-검정-likelihood-ratio-test">통계적 검정: Likelihood ratio test</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Linear mixed effects model</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Yoon-Ho Hong </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 27, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="선형혼합효과-모델linear-mixed-effects-model" class="level2">
<h2 class="anchored" data-anchor-id="선형혼합효과-모델linear-mixed-effects-model">선형혼합효과 모델(Linear mixed effects model)</h2>
<p>gdpPercap_log10과 continent 변수, 그리고 두 변수간의 교호작용을 예측변수로 하고, 기대수명을 결과변수로 하는 다변량 선형회귀 모델에서 다음과 같은 사실을 알 수 있었습니다.</p>
<ul>
<li>continent에 따라 기대수명이 다름<br>
</li>
<li>gdpPercap_log10이 증가함에 따라 기대수명이 증가함<br>
</li>
<li>continent에 따라 gdpPercap_log10이 기대수명에 미치는 효과가 다름</li>
</ul>
<p>그렇다면, 두 변수간의 교호작용을 예측변수로 포함한 것과 그렇지 않은 모델 중에서 어떤 것을 선택해야 할까요?</p>
<ul>
<li><ol type="1">
<li>lifeExp ~ gdpPercap_log10 + continent</li>
</ol></li>
<li><ol start="2" type="1">
<li>lifeExp ~ gdpPercap_log10*continent</li>
</ol></li>
</ul>
<p>첫번째 모델은 두 변수간의 교호작용을 고려하지 못하고 있고, 두번째 모델은 아래와 같이 continent 와 gdpPercap_log10:continent 변수의 공선성이 매우 크다는 것을 알 수 있습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gapminder)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df_1952 <span class="ot">=</span> gapminder <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">1952</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gdpPercap_log10 =</span> <span class="fu">log10</span>(gdpPercap)) </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>lm3_1952 <span class="ot">=</span> <span class="fu">lm</span>(lifeExp <span class="sc">~</span> gdpPercap_log10<span class="sc">*</span>continent, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> df_1952)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm3_1952)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = lifeExp ~ gdpPercap_log10 * continent, data = df_1952)

Residuals:
     Min       1Q   Median       3Q      Max 
-14.7288  -3.5801   0.1119   2.5009  15.2270 

Coefficients:
                                  Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)                         23.053      8.239   2.798  0.00591 **
gdpPercap_log10                      5.382      2.743   1.962  0.05184 . 
continentAmericas                  -54.739     19.795  -2.765  0.00650 **
continentAsia                       -7.220     10.754  -0.671  0.50312   
continentEurope                    -34.999     17.645  -1.984  0.04938 * 
continentOceania                    -3.480   1571.782  -0.002  0.99824   
gdpPercap_log10:continentAmericas   18.659      5.774   3.231  0.00156 **
gdpPercap_log10:continentAsia        4.196      3.483   1.205  0.23048   
gdpPercap_log10:continentEurope     15.350      5.038   3.047  0.00279 **
gdpPercap_log10:continentOceania     6.999    391.713   0.018  0.98577   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6.04 on 132 degrees of freedom
Multiple R-squared:  0.7715,    Adjusted R-squared:  0.7559 
F-statistic: 49.52 on 9 and 132 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(lm3_1952)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>there are higher-order terms (interactions) in this model
consider setting type = 'predictor'; see ?vif</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  GVIF Df GVIF^(1/(2*Df))
gdpPercap_log10           5.879826e+00  1        2.424835
continent                 2.771206e+11  4       26.936031
gdpPercap_log10:continent 3.249760e+11  4       27.477766</code></pre>
</div>
</div>
</section>
<section id="고정-효과와-랜덤-효과" class="level2">
<h2 class="anchored" data-anchor-id="고정-효과와-랜덤-효과">고정 효과와 랜덤 효과</h2>
<p>위와 같은 상황에서 선형혼합모형은 좋은 대안이 될 수 있습니다. 선합혼합모형은 고정 효과(fixed effect)와 랜덤 효과(random effect)로 이루어진 모형을 말하며, 다음과 같은 상황에서 좋은 분석 방법이 될 수 있습니다.</p>
<ul>
<li>데이터가 군집(cluster)으로 구성되어 있거나,<br>
</li>
<li>반복 측정 데이터인 경우(예를 들면, longitudinal data)</li>
</ul>
<p>먼저 고정 효과와 랜덤 효과의 차이에 대해 이야기해 보겠습니다. 이 차이는 변수 자체와는 거의 관련이 없으며 연구 질문과 더 관련이 있다는 점을 꼭 기억하시기 바랍니다. 많은 경우 동일한 변수가 랜덤 효과 또는 고정 효과로 간주될 수 있으므로, 항상 연구 질문(즉, 가설)이 무엇인지를 참조하여 그에 따라 모델을 구성해야합니다.</p>
<p>넓은 의미에서 고정 효과는 결과 변수에 영향을 미칠 것으로 예상되는 변수로, 선형회귀 분석에서 설명 변수라고 부르는 것입니다. gapminder 사례에서 우리는 일인당 국민소득이 기대수명에 어떤 영향을 미치는지에 대한 결론을 내리는 데 관심이 있습니다. 따라서 일인당 국민소득은 고정 효과 변수입니다.</p>
<p>반면에 랜덤 효과는 일반적으로 우리가 통제하고자 하는 요인을 그룹화하는 것으로 항상 범주형입니다. 대부분의 경우 우리는 랜덤 효과 변수가 결과 변수에 미치는 영향에 특별히 관심이 없지만, 우리가 보는 고정 효과 변수가 결과 변수에 미치는 효과에 영향을 미칠 수 있다는 것을 알고 있습니다.</p>
<p>우리는 continent에 따라 기대수명이 얼마나 달라지는지를 추정하는 데는 관심이 없지만, continent가 기대수명이 다른 이유일 수 있다는 것을 알고 있으며, 각 continent에서 기대수명을 예측할 때 이로 인한 변동이 얼마나 되는지 알고 싶습니다.</p>
</section>
<section id="랜덤-절편" class="level2">
<h2 class="anchored" data-anchor-id="랜덤-절편">랜덤 절편</h2>
<p>랜덤 효과는 크게 random intercepts와 random slopes, 이렇게 두 가지 방식으로 모형화가 가능합니다.</p>
<p>먼저, continent에 대해 random intercept 효과를 도입한 모형을 먼저 살펴보겠습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>lme_mod1 <span class="ot">=</span> <span class="fu">lmer</span>(lifeExp <span class="sc">~</span> gdpPercap_log10 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>continent), <span class="at">data =</span> df_1952)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lme_mod1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: lifeExp ~ gdpPercap_log10 + (1 | continent)
   Data: df_1952

REML criterion at convergence: 934.2

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.56354 -0.52248 -0.00694  0.54308  2.22869 

Random effects:
 Groups    Name        Variance Std.Dev.
 continent (Intercept) 57.02    7.551   
 Residual              39.87    6.315   
Number of obs: 142, groups:  continent, 5

Fixed effects:
                Estimate Std. Error t value
(Intercept)       14.149      6.389   2.215
gdpPercap_log10   11.457      1.549   7.398

Correlation of Fixed Effects:
            (Intr)
gdpPrcp_l10 -0.837</code></pre>
</div>
</div>
<p>먼저 랜덤 효과에 대한 결과를 살펴보겠습니다. continent에 대한 분산과 표준 편차를 살펴보겠습니다. 이는 continent로 인해 기대수명에 얼마나 많은 변동성이 있는지를 측정한 값입니다. 그 아래에 contiennt에 기인하지 않은 변동성을 나타내는 “residual”이 표시됩니다. 이것은 continent 인한 것이 아닌 기대수명의 랜덤 편차입니다. 여기에는 기대수명에 영향을 미치는 다른 요인이 있다는 사실이 반영되어 있습니다.</p>
<p>고정 효과에 대한 결과는 선형 모델 분석 결과를 설명할 때 고려했던 계수 표와 유사합니다.<br>
계수 “gdpPercap_log10”은 일인당 국민소득의 효과에 대한 기울기입니다. 그리고, 이 추정치를 표준 오차로 나눈 값인 t값이 있습니다.</p>
</section>
<section id="랜덤-기울기" class="level2">
<h2 class="anchored" data-anchor-id="랜덤-기울기">랜덤 기울기</h2>
<p>다음으로, continent에 대해 random intercept에 random slope 효과까지 도입한 모형을 살펴보겠습니다.</p>
<p>random intercept 모델에서는 기준값의 차이를 고려하지만, gdpPercap_log10의 효과가 어떻든 모든 continent에 동일하게 적용될 것이라고 가정합니다. 하지만 이것이 유효한 가정일까요?</p>
<p>실제로는 그렇지 않은 경우가 많으며, gdpPercap_log10의 효과는 continent에 따라 다를 수 있습니다.따라서 continent에 서로 다른 intercept가 허용될 뿐만 아니라 gdpPercap_log10의 효과에 대해서도 서로 다른 기울기를 가질 수 있는 random slopes 모델이 필요합니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lme_mod2 <span class="ot">=</span> <span class="fu">lmer</span>(lifeExp <span class="sc">~</span> gdpPercap_log10 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">+</span>gdpPercap_log10<span class="sc">|</span>continent), <span class="at">data =</span> df_1952)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lme_mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: lifeExp ~ gdpPercap_log10 + (1 + gdpPercap_log10 | continent)
   Data: df_1952

REML criterion at convergence: 922.8

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.30539 -0.59288  0.03753  0.43425  2.43247 

Random effects:
 Groups    Name            Variance Std.Dev. Corr 
 continent (Intercept)     275.21   16.589        
           gdpPercap_log10  45.87    6.772   -1.00
 Residual                   36.46    6.038        
Number of obs: 142, groups:  continent, 5

Fixed effects:
                Estimate Std. Error t value
(Intercept)       0.8606     8.7700   0.098
gdpPercap_log10  14.7845     3.3381   4.429

Correlation of Fixed Effects:
            (Intr)
gdpPrcp_l10 -0.986</code></pre>
</div>
</div>
<p>아래에서 continent에 따라 gdpPercap_log10의 효과가 어떻게 다르게 나타나는지 확인해볼 수 있습니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(lme_mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$continent
         (Intercept) gdpPercap_log10
Africa     22.421966        5.662431
Americas   -2.403154       15.865920
Asia       10.651513       11.090122
Europe    -15.483842       21.639893
Oceania   -10.883497       19.664281

attr(,"class")
[1] "coef.mer"</code></pre>
</div>
</div>
</section>
<section id="통계적-검정-likelihood-ratio-test" class="level2">
<h2 class="anchored" data-anchor-id="통계적-검정-likelihood-ratio-test">통계적 검정: Likelihood ratio test</h2>
<p>이제 p값을 구해 보겠습니다. 위에서 만든 모델(lme_mod2)을 유지한 채 likelihood ratio test를 이용해 새로운 null 모델과 비교합니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>null_mod <span class="ot">=</span> <span class="fu">lmer</span>(lifeExp <span class="sc">~</span> (<span class="dv">1</span><span class="sc">+</span>gdpPercap_log10<span class="sc">|</span>continent), <span class="at">data =</span> df_1952)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lme_mod2, null_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>refitting model(s) with ML (instead of REML)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: df_1952
Models:
null_mod: lifeExp ~ (1 + gdpPercap_log10 | continent)
lme_mod2: lifeExp ~ gdpPercap_log10 + (1 + gdpPercap_log10 | continent)
         npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)   
null_mod    5 948.28 963.06 -469.14   938.28                        
lme_mod2    6 941.18 958.91 -464.59   929.18 9.1046  1    0.00255 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>이상을 정리하면, 일인당 국민소득과 기대수명 사이의 관계에 대한 linear mixed effects model 분석을 수행하였고, 고정 효과로 gdpPercap_log10을 입력하였고 랜덤 효과로는 continent의 효과에 대한 random slope와 random intercept를 사용했습니다. 해당 효과가 있는 전체 모델과 고정 효과로 gdpPercap_log10가 없는 모델을 비교하여 likelihood ratio test로 검정한 결과, 일인당 국민소득이 기대수명에 유의한 효과가 있음을 확인할 수 있었습니다.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>