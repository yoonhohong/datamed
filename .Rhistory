# 정제 & 가공
# 이상치 완화
df$bmi = ifelse(df$bmi < 15, 15, bmi)
names(df)
# 정제 & 가공
# 이상치 완화
df$bmi = ifelse(df$bmi < 15, 15, df$bmi)
# 표1 (baseline characteristics)
vars <- c("age","bmi","num_comorbidities","outpatient_visits","cognitive_score")
facvars <- c("sex","insurance_quartile","depression_dx")
?CreateTableOne
df$sex
# 표1 (baseline characteristics)
vars <- c("age","bmi","num_comorbidities","outpatient_visits","cognitive_score")
facvars <- c("sex","insurance_quartile","depression_dx")
tab1 <- CreateTableOne(vars = c(vars, facvars),
strata = "medication_adherence",
data = df,
factorVars = facvars)
print(tab1,
showAllLevels = TRUE,
quote = FALSE, noSpaces = TRUE)
tab1
?CreateTableOne
df %>%
ggplot(aes(age, group = medication_adherence)) +
geom_density()
df %>%
ggplot(aes(age, fill = medication_adherence)) +
geom_density()
df %>%
ggplot(aes(age, fill = medication_adherence)) +
geom_histogram()
?geom_histogram
df %>%
ggplot(aes(age, fill = medication_adherence)) +
geom_histogram()
df %>%
ggplot(aes(age, fill = medication_adherence)) +
geom_histogram(alpha = 0.5)
df %>%
ggplot(aes(age, fill = medication_adherence)) +
geom_histogram()
# 표1 (baseline characteristics)
plot(density(df$age))
# 표1 (baseline characteristics)
plot(density(df$age))
# 표1 (baseline characteristics)
plot(density(df$age, na.rm = T))
df %>%
ggplot(aes(age, group = medication_adherence)) +
geom_density()
df %>%
ggplot(aes(age, group = medication_adherence)) +
geom_density(fill = medication_adherence)
df %>%
ggplot(aes(age, group = medication_adherence, fill = medication_adherence)) +
geom_density()
df %>%
ggplot(aes(age, group = medication_adherence, fill = medication_adherence, alpha = 0.5)) +
geom_density()
df %>%
ggplot(aes(age, group = medication_adherence, fill = medication_adherence)) +
geom_density(alpha = 0.5)
t.test(age ~ medication_adherence, data=df)
df %>%
group_by(medication_adherence) %>%
summarize(mean_age = mean(age),
sd = sd(age))
df %>%
group_by(medication_adherence) %>%
summarize(mean_age = mean(age, na.rm = T),
sd = sd(age, na.rm = T))
df = df[complete.cases(df),]
# 예) age: t-test vs Wilcoxon
t.test(age ~ medication_adherence, data=df)
wilcox.test(bmi ~ medication_adherence, data=df)
df %>%
ggplot(aes(age, group = medication_adherence, fill = medication_adherence)) +
geom_density(alpha = 0.5)
df %>%
group_by(medication_adherence) %>%
summarize(mean_age = mean(age),
sd = sd(age))
# 예) 범주형: 카이제곱 vs Fisher
tbl <- table(df$medication_adherence, df$depression_dx)
chisq.test(tbl)       # 기대도수 충분하면 OK
fisher.test(tbl)      # 표본 적거나 희귀범주면 이게 더 안전
df %>%
ggplot(aes(x = medication_adherence,
y = age)) +
geom_boxplot() +
labs(x="Adherent (0/1)", y="Age")
df %>%
ggplot(aes(x = medication_adherence,
y = age)) +
geom_boxplot() +
labs(x="Medication adherence", y="Age")
class(df$dementia_dx)
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar() +
scale_y_continuous(labels=scales::percent) +
labs(x="Medication adherence",
y="Proportion (%)",
fill="Dementia")
?geom_bar
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar() +
scale_y_continuous()
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar()
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar(position = "fill")
?geom_bar
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar(position = "fill")
# 예) 범주형: 카이제곱 vs Fisher
tbl <- table(df$medication_adherence, df$dementia_dx)
chisq.test(tbl)       # 기대도수 충분하면 OK
fisher.test(tbl)      # 표본 적거나 희귀범주면 이게 더 안전
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar(position = "fill")
tbl
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar(position = "fill")
?prop.table
prop.table(tbl)
prop.table(tbl, margin = 1)
df %>%
ggplot(aes(x = medication_adherence,
fill = dementia_dx)) +
geom_bar(position = "fill")
chisq.test(tbl)       # 기대도수 충분하면 OK
fisher.test(tbl)      # 표본 적거나 희귀범주면 이게 더 안전
# 예) age: t-test vs Wilcoxon
t.test(age ~ medication_adherence, data=df)
wilcox.test(bmi ~ medication_adherence, data=df)
df %>%
ggplot(aes(age, group = medication_adherence, fill = medication_adherence)) +
geom_density(alpha = 0.5)
df %>%
ggplot(aes(x = medication_adherence,
y = age)) +
geom_boxplot() +
labs(x="Medication adherence", y="Age")
df %>%
group_by(medication_adherence) %>%
summarize(mean_age = mean(age),
sd = sd(age))
names(df)
# 7) Kaplan–Meier & 로그순위
fit_km <- survfit(Surv(time_to_dementia, event) ~
medication_adherence,
data = df)
fit_km
ggsurvplot(fit_km, data = df,
risk.table = TRUE,
conf.int = TRUE)
survdiff(Surv(time_to_dementia, event) ~
medication_adherence, data = df))
survdiff(Surv(time_to_dementia, event) ~
medication_adherence, data = df)
names(df)
# 8) Cox 회귀
cox_formula <- as.formula(Surv(time_to_dementia, event) ~
medication_adherence +
age +
sex +
num_comorbidities +
insurance_quartile +
outpatient_visits +
bmi + depression_dx +
cognitive_score)
fit_cox <- coxph(cox_formula, data = df)
summary(fit_cox)
# 비례위험 가정 점검
zph <- cox.zph(fit_cox)
zph
plot(zph)  # 그래프 확인 원하면 주석 해제
plot(zph)  # 그래프 확인 원하면 주석 해제
# 결과 요약 & Forest plot
coxt <- broom::tidy(fit_cox, exponentiate = TRUE, conf.int = TRUE)
coxt
forest <- ggplot(coxt, aes(x = reorder(term, estimate),
y = estimate,
ymin = conf.low,
ymax = conf.high)) +
geom_pointrange() + coord_flip() + theme_minimal() +
geom_hline(yintercept = 1, linetype = 2) +
labs(x="", y="Hazard Ratio (95% CI)")
print(forest)
print(forest)
# 결과 요약 & Forest plot
coxt <- broom::tidy(fit_cox, exponentiate = TRUE, conf.int = TRUE)
coxt
forest <- ggplot(coxt, aes(x = reorder(term, estimate),
y = estimate,
ymin = conf.low,
ymax = conf.high)) +
geom_pointrange() + coord_flip() + theme_minimal() +
geom_hline(yintercept = 1, linetype = 2) +
labs(x="", y="Hazard Ratio (95% CI)")
print(forest)
coxt
plot_KM = ggsurvplot(fit_km, data = df,
risk.table = TRUE,
conf.int = TRUE)
plot_KM
plot_KM = ggsurvplot(fit_km, data = df,
risk.table = TRUE,
conf.int = TRUE)
plot_KM
dev.off()
dev.off()
plot_KM = ggsurvplot(fit_km, data = df,
risk.table = TRUE,
conf.int = TRUE)
plot_KM
# 이미지 저장
ggsave(plot_KM,
"img/km_curve.png", width = 7, height = 5, dpi = 300)
plot_KM
?ggsave
# 이미지 저장
ggsave(plot = plot_KM,
"img/km_curve.png", width = 7, height = 5, dpi = 300)
# 이미지 저장
ggsave(plot = plot_KM,
filename = "img/km_curve.png",
width = 7, height = 5, dpi = 300)
# 이미지 저장
ggsave(filename = "img/km_curve.png",
plot = plot_KM,
width = 7, height = 5, dpi = 300)
# 이미지 저장
ggsave(filename = "img/km_curve.png",
plot = plot_KM,
width = 7, height = 5, dpi = 300)
# 이미지 저장
ggsave(filename = "img/km_curve.png",
width = 7, height = 5, dpi = 300)
# 이미지 저장
ggsave(filename = "img/km_curve.png",
width = 7, height = 5, dpi = 300)
# 이미지 저장
ggsave(plot_KM$plot, filename = "img/km_curve.png",
width = 7, height = 5, dpi = 300)
plot_KM
attributes(plot_KM)
ggsave(plot_KM$table, filename = "img/risk_table.png",
width = 7, height = 5, dpi = 300)
?fct_collapse
broom::tidy(fit_cox,
exponentiate = TRUE,
conf.int = TRUE)
conf.int = TRUE)
broom::tidy(fit_cox,
exponentiate = TRUE,
conf.int = TRUE)
broom::tidy(fit_cox,
exponentiate = TRUE,
conf.int = TRUE) -> df_tidy
broom::tidy(fit_cox,
exponentiate = TRUE,
conf.int = TRUE) -> cox_tidy
cox_tidy %>%
ggplot(aes(x = reorder(term, estimate), y = estimate, ymin = conf.low, ymax = conf.high)) +
geom_pointrange() + coord_flip() + theme_minimal() +
geom_hline(yintercept = 1, linetype = 2) +
labs(x="", y="Hazard Ratio (95% CI)")
broom::tidy(fit_cox,
exponentiate = TRUE,
conf.int = TRUE) -> cox_tidy
cox_tidy
?reorder
cox_tidy %>%
ggplot(aes(x = reorder(term, estimate),
y = estimate,
ymin = conf.low,
ymax = conf.high)) +
geom_pointrange() +
coord_flip() +
theme_minimal() +
geom_hline(yintercept = 1, linetype = 2) +
labs(x="", y="Hazard Ratio (95% CI)")
cox_tidy %>%
ggplot(aes(x = reorder(term, estimate),
y = estimate,
ymin = conf.low,
ymax = conf.high)) +
geom_pointrange() +
coord_flip() +
theme_minimal() +
geom_hline(yintercept = 1, linetype = "dashed") +
labs(x="", y="Hazard Ratio (95% CI)")
df <- readr::read_csv("data/antihypertensive_dementia.csv")
glimpse(df)
summary(df)
sapply(df, function(x) sum(is.na(x)))
knitr::opts_chunk$set(echo = TRUE, eval = F)
df <- readr::read_csv("data/antihypertensive_dementia.csv")
glimpse(df)
summary(df)
sapply(df, function(x) sum(is.na(x)))
?sapply
fit_cox <- coxph(Surv(time, event) ~
medication_adherence +
age + sex,
data = df)
df <- readr::read_csv("data/antihypertensive_dementia.csv")
glimpse(df)
summary(df)
sapply(df, function(x) sum(is.na(x)))
df <- df %>%
mutate(bmi = ifelse(bmi<15, 15, bmi),
sex = factor(sex))
df <- df %>%
event = ifelse(!is.na(event_dementia), event_dementia, dementia_dx)
event_dementia, dementia_dx)
df <- df %>%
mutate(age_group = cut(age,
breaks = c(60,70,80,90,Inf),
right = FALSE),
event = ifelse(!is.na(event_dementia),
event_dementia, dementia_dx))
names(df)
df <- df %>%
mutate(age_group = cut(age,
breaks = c(60,70,80,90,Inf),
right = FALSE),
event = ifelse(!is.na(event),
event, dementia_dx))
df %>%
ggplot(aes(x = medication_adherence,
y = age)) +
geom_boxplot()
fit_km <- survfit(Surv(time, event) ~
medication_adherence,
data = df)
fit_km <- survfit(Surv(time_to_event, event) ~
medication_adherence,
data = df)
names(df)
fit_km <- survfit(Surv(time_to_dementia, event) ~
medication_adherence,
data = df)
ggsurvplot(fit_km,
data = df,
risk.table = TRUE,
conf.int = TRUE)
survdiff(Surv(time_to_dementia, event) ~
medication_adherence, data = df)
fit_cox <- coxph(Surv(time_to_dementia, event) ~
medication_adherence +
age + sex,
data = df)
summary(fit_cox)
broom::tidy(fit_cox,
exponentiate = TRUE,
conf.int = TRUE) -> cox_tidy
cox_tidy %>%
ggplot(aes(x = reorder(term, estimate),
y = estimate,
ymin = conf.low,
ymax = conf.high)) +
geom_pointrange() +
coord_flip() +
theme_minimal() +
geom_hline(yintercept = 1, linetype = "dashed") +
labs(x="", y="Hazard Ratio (95% CI)")
knitr::opts_chunk$set(echo = TRUE, eval = F)
# 중복 확인
gapminder %>% distinct()
# install.packages(c("gapminder", "dplyr", "tidyr", "ggplot2"))
library(gapminder)
library(dplyr)
library(tidyr)
library(ggplot2)
# 중복 확인
gapminder %>% distinct()
# 결측치 개수 확인
colSums(is.na(gapminder))
gapminder %>%
select(continent, country) %>%
distinct()
gapminder %>%
filter(year == 1957)
gapminder %>%
filter(country == "Korea, Rep.")
gapminder %>%
arrange(gdpPercap)
gapminder %>%
arrange(desc(gdpPercap))
gapminder %>%
mutate(pop = pop/1000000)
gapminder %>%
mutate(gdp = gdpPercap*pop)
gapminder %>%
filter(year == 2007) %>%
summarize(meanLifeExp = mean(lifeExp))
gapminder %>%
group_by(year) %>%
summarise(meanLifeExp = mean(lifeExp))
gapminder %>%
group_by(continent, year) %>%
summarize(meanLifeExp = mean(lifeExp))
df1 <- data.frame(
country=c("Korea","Japan","China"),
life_exp=c(80,83,67))
df2 <- data.frame(
country=c("Korea","Japan","Taiwan"),
pop_mil=c(50,100,10))
inner_join(df1, df2, by="country")
left_join(df1, df2, by="country")
right_join(df1, df2, by="country")
full_join(df1, df2, by="country")
x = c("a", "b", "c")
y = c("b", "c", "d")
intersect(x, y) # 교집합
setdiff(x, y) # 여집합
union(x, y) # 합집합
continent_gapminder <- gapminder %>%
group_by(continent, year) %>%
summarize(lifeExp = mean(lifeExp),
pop = mean(pop),
gdpPercap = mean(gdpPercap))
# Wide → Long
long_data <- continent_gapminder %>%
pivot_longer(cols = lifeExp:gdpPercap,
names_to = "variable",
values_to = "value")
# Long → Wide
long_data %>%
pivot_wider(names_from = variable,
values_from = value)
gapminder %>%
filter(year == 2007) %>%
ggplot(aes(x=gdpPercap, y=lifeExp)) +
geom_point()
gapminder %>%
filter(year == 2007) %>%
ggplot(aes(x=gdpPercap, y=lifeExp,
color = continent,
size = pop)) +
geom_point()
gapminder %>%
filter(year == 2007) %>%
ggplot(aes(x=gdpPercap, y=lifeExp,
color = continent,
size = pop)) +
geom_point() +
facet_grid(.~continent)
gapminder %>%
group_by(continent, year) %>%
summarize(meanLifeExp = mean(lifeExp)) %>%
ggplot(aes(x=year, y=meanLifeExp,
color=continent)) +
geom_line()
gapminder %>%
select(continent, country) %>%
distinct() %>%
ggplot(aes(continent, fill = continent)) +
geom_bar()
gapminder %>%
select(continent, country) %>%
distinct() %>%
ggplot(aes(continent, fill = continent)) +
geom_bar()
ggplot(gapminder, aes(x=lifeExp)) +
geom_histogram()
ggplot(gapminder, aes(x=lifeExp)) +
geom_histogram(binwidth = 5)
ggplot(gapminder,
aes(x=continent, y=lifeExp)) +
geom_boxplot()
ggplot(gapminder,
aes(x=continent, y=lifeExp)) +
geom_violin()
ggplot(gapminder,
aes(x=continent, y=lifeExp)) +
geom_boxplot() +
labs(title = "Distribution of life expectancy across different continents",
x = "Continent",
y = "Life expectancy (years)")
ggplot(gapminder,
aes(x=continent, y=lifeExp)) +
geom_boxplot() +
labs(title = "Distribution of life expectancy across different continents",
x = "Continent",
y = "Life expectancy (years)") +
theme(text = element_text(size = 16))
knitr::opts_chunk$set(echo = TRUE, eval = F)
# PH 가정 점검
zph <- cox.zph(fit_cox)
zph
plot(zph)
zph
q()
