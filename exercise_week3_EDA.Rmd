---
title: "항고혈압제 장기 복용과 치매 위험"
subtitle: "분석 가이드"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  revealjs::revealjs_presentation:
    self_contained: true
    theme: simple
    transition: fade
    slideNumber: true
    code_folding: show
---

```{=html}
<style type="text/css">
p, li {
  text-align: left;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = F)
```

## 연구 질문 & 가설

**연구 질문**: 항고혈압제의 **지속 복용**은 치매 발생 위험을 낮추는가?\
**귀무가설(H0)**: 지속 복용군과 비교군의 치매 발생 위험에 **차이가 없음**.\
**대립가설(H1)**: 지속 복용군의 치매 발생 위험이 **더 낮다**.

> 임상적 해석: HR (Hazard ratio) = 0.74라면 **약 26% 위험 감소**. 신뢰구간과 p값을 함께 본다.

-------------------------

## 변수 & 사전 설계 점검

- medication_adherence: High vs. Low 
- 치매 진단: dementia_dx or event 
- 공변량: age, sex, insurance_quartile (교육 proxy), num_comorbidities, outpatient_visits, cognitive_score, bmi, depression_dx

------------------

## 전체 워크플로우

1)  데이터 확인 → 2) 정제 → 3) 가공 → 4) 기술통계/EDA → 5) 생존곡선 & 로그순위검정 → 6) Cox 회귀 → 7) 가정 점검 & 민감도분석 → 8) 보고

------------------

## 1) 데이터 확인 (Data Understanding)

-   파일 읽기 & 구조 파악
-   변수 타입 점검 (연속/범주)
-   결측치 분포 확인

``` {r}
df <- readr::read_csv("data/antihypertensive_dementia.csv") 
glimpse(df)
summary(df)
sapply(df, function(x) sum(is.na(x))) 
```

--------------------

## 2) 데이터 정제 (Cleaning)

- 공백 정리
- 오탈자 정리 
- 이상치 완화(예: **BMI 하한**)
- 범주형 변환 & 레이블 정리
- 결측치 처리 전략: 제거 vs 대체(명시)

``` {r}
df <- df %>%
  mutate(bmi = ifelse(bmi<15, 15, bmi),
         sex = factor(sex))
# fct_collpase()
```

---------------------------

## 3) 데이터 가공 (Wrangling)

-   나이 그룹화: `cut()`
-   생존분석 입력 변수 구성: `time_to_event`, `event`(0/1)

``` {r}
df <- df %>%
  mutate(age_group = cut(age, 
                         breaks = c(60,70,80,90,Inf), 
                         right = FALSE),
    event = ifelse(!is.na(event), 
                   event, dementia_dx))
```

----------------

## 4) 기술 통계 & 그룹 비교

-   Table: 기초 특성 (지속 복용 vs 비복용/불규칙)
-   연속형: t-test / wilcoxon rank sum test.\
-   범주형: chi-square test, Fisher's exact test

``` {r}
# t.test()
# wilcox.test()
# chisq.test()
# fisher.test()
```

-----------------------

## 5) 탐색적 시각화

-   분포 확인: 히스토그램/박스플롯
-   그룹 차이: 막대/바이올린
-   노출--결과 연관의 조감

``` {r}
df %>%
   ggplot(aes(x = medication_adherence, 
              y = age)) +
   geom_boxplot() 

# geom_histogram()
# geom_bar() 
```


## 6) 생존곡선 & 로그순위 검정

-   입력: `Surv(time, event)`
-   군별 생존곡선: `survfit()`
-   비교: `survdiff()`

``` {r}
fit_km <- survfit(Surv(time_to_dementia, event) ~ 
                    medication_adherence, 
                  data = df)
ggsurvplot(fit_km, 
           data = df, 
           risk.table = TRUE, 
           conf.int = TRUE)
survdiff(Surv(time_to_dementia, event) ~ 
           medication_adherence, data = df)
```

-------------------------

## 7) 다변량 Cox 회귀 & 가정 점검

-   공변량 통제.\
-   비례위험 가정 점검: `cox.zph()`

``` {r}
fit_cox <- coxph(Surv(time_to_dementia, event) ~
                   medication_adherence +
                   age + sex,
                 data = df)
summary(fit_cox)

# PH 가정 점검
zph <- cox.zph(fit_cox)
zph
plot(zph)
```

----------------------

## 8) 결과 보고 & 시각화

-   핵심 지표: HR(95% CI), p-value
-   Forest plot로 가독성 향상

```{r}
broom::tidy(fit_cox, 
            exponentiate = TRUE, 
            conf.int = TRUE) -> cox_tidy
cox_tidy %>%
  ggplot(aes(x = reorder(term, estimate), 
             y = estimate, 
             ymin = conf.low, 
             ymax = conf.high)) +
  geom_pointrange() + 
  coord_flip() + 
  theme_minimal() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(x="", y="Hazard Ratio (95% CI)")
```

----------------------

## (선택) 서브그룹

- 연령/성별/교육 proxy 서브그룹 분석\

----------------------

## 체크리스트

- **서브그룹 차이**가 선택/접근성 편향을 반영하는가?


