---
title: "Exercise week 3: EDA"
output:
  revealjs::revealjs_presentation:
    self_contained: true
    transition: slide
    center: false
    reveal_options:
      slideNumber: true
      hash: true
      controls: true
      progress: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

## 1) 데이터 로딩 & 빠른 확인
**무엇을 하나요?**  
- 데이터를 읽고, **앞부분/구조/요약**을 확인합니다.    
- 결측/중복/라벨/범위 문제를 대략적으로 스캔합니다.   

---

```{r}
library(tidyverse) 
path_data <- "data/antihypertensive_dementia.csv"
df <- read.csv(path_data)
head(df)
glimpse(df)
summary(df)
```

## 2) 간단한 품질 지표 확인 

### 2-1) 범주형 

```{r}
table(df$sex) # M, F, Male, Female 
table(df$insurance_quartile, useNA = "ifany")
table(df$num_comorbidities)
table(df$depression_dx)
table(df$medication_adherence) # H, High, L, Low 
table(df$dementia_dx) # no, No, yes, Yes 
```

---

### 2-2) 연속형 

```{r}
plot(density(df$bmi, na.rm = T))
plot(density(df$outpatient_visits)) # errors, outliers 
plot(density(df$cognitive_score, na.rm = T)) 
plot(density(df$time_to_dementia))
range(df$time_to_dementia)
```

---

### 2-3) 이상치 비율 구하기 

```{r}
df %>% summarise(
  bad_visits = mean(outpatient_visits < 0 | outpatient_visits > 60, na.rm=TRUE),
  bad_bmi    = mean(bmi < 15 | bmi > 50, na.rm=TRUE),
  bad_time   = mean(time_to_dementia <= 0, na.rm=TRUE)
)
```

---

## 3) 데이터 정제 (라벨 통일 / 결측 처리 / 이상치 / 중복 제거)
**무엇을 하나요?**  
- 라벨을 통일하고  
- 결측치를 간단하게 처리하고   
- 이상치를 완화하고    
- 중복을 제거합니다    

---

### 3-1) 라벨 정리 

```{r}
df2 <- df %>%
  mutate(
    sex = recode(sex, "M"="Male","F"="Female", .default = sex),
    medication_adherence = recode(medication_adherence, 
                            "H" = "High", "L" = "Low", 
                          .default = medication_adherence), 
    dementia_dx = recode(dementia_dx, "No" = "no", 
                         "Yes" = "yes", 
                         .default = dementia_dx))
```

---

### 3-2) 형변환; character -> factor 

```{r}
df3 = df2 %>%
  mutate(sex = factor(sex), 
         medication_adherence = factor(medication_adherence), 
         dementia_dx = factor(dementia_dx))
summary(df3)
```

---

### 3-3) 간단 결측 처리 (예시: 중앙값/최빈값)

```{r}
df5 = df4 %>%
  mutate(insurance_quartile = 
           if_else(is.na(insurance_quartile), 
                   median(insurance_quartile, na.rm=TRUE), 
                   insurance_quartile),
    age = if_else(is.na(age), 
                  round(median(age, na.rm=TRUE)), age),
    cognitive_score = if_else(is.na(cognitive_score),
                  median(cognitive_score, na.rm=TRUE), 
                  cognitive_score),
    bmi = if_else(is.na(bmi), median(bmi, na.rm=TRUE), bmi)
  ) 
```

--- 

### 3-4) 이상치 완화 및 중복 제거 

```{r}
df5 = df5 %>%
  mutate(
    bmi = pmin(pmax(bmi, 15), 50),
    outpatient_visits = pmin(pmax(outpatient_visits, 0), 60),
    time_to_dementia = if_else(
      time_to_dementia <= 0, 1, time_to_dementia) 
    # 최소 1개월로 보정
  ) %>%
  distinct() # 중복 제거
```

---

### 3-5) 형변환: 연속형 -> 범주형 

```{r}
df6 = df5 %>%
  mutate(bmi_class = cut(bmi, 
                         breaks = c(-Inf, 18.5, 25, 30, Inf), 
                         labels = c("Under","Normal","Over",
                                    "Obese")), 
         age_group = cut(age, breaks=c(60,70,80,Inf), 
                         right=FALSE))
```

---

## 4) 생존분석 맛보기 (KM / Log-rank)
**무엇을 하나요?**  
- Kaplan–Meier 곡선으로 복약군별 **치매 무발생 생존**을 비교하고,  
- 로그순위 검정으로 곡선 차이를 테스트합니다.

---

### 4-1) KM 분석 

```{r}
library(survival)
library(survminer)
df_surv <- df6 %>%
  mutate(adherent = 
           factor(medication_adherence,
                  levels=c("Low","High")))
fit_km <- survfit(
  Surv(time_to_dementia, event) ~ adherent, 
  data = df_surv)
ggsurvplot(fit_km, conf.int = TRUE, 
           risk.table = TRUE,
           legend.labs = c("Low","High"),
           xlab = "Months", 
           ylab = "Dementia-free survival")
```

---

### 4-2) Log-rank test

```{r}
survdiff(
  Surv(time_to_dementia, event) ~ adherent, 
  data = df_surv)
```

---

## 5) 연습

- 결측 처리 전략(중앙값/최빈값 vs 제거)을 바꿔보고 결과 비교하기  
- `outpatient_visits`를 구간화해서(`0–6 / 7–12 / 13–18 / 19+`) KM 곡선 층화 비교  
